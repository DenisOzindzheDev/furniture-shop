name: Test-PR

on:
  pull_request:
    branches: [ "master" ]
  push:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup vars
      id: vars
      run: |
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ Ñ…ÑÑˆ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ°
        echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ¼Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ°
        echo "AUTHOR=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ° (Ğ¿ĞµÑ€Ğ²Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ°)
        COMMIT_MSG=$(git log -1 --pretty=format:'%s')
        echo "COMMIT_MSG=$COMMIT_MSG" >> $GITHUB_OUTPUT
        
        # Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ
        echo "BUILD_TIME=$(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT
    
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag fs:${{ steps.vars.outputs.SHORT_SHA }}
    
    - name: Send build success message to Telegram
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          âœ… Furniture Shop CI/CD
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          ğŸ“Š Build Status: SUCCESS
          ğŸ·ï¸ Version: ${{ steps.vars.outputs.SHORT_SHA }}
          âš¡ Trigger: ${{ github.event_name }}
          ğŸ‘¤ Author: ${{ steps.vars.outputs.AUTHOR }}
          
          ğŸ“ Commit Message:
          ${{ steps.vars.outputs.COMMIT_MSG }}
          
          ğŸŒ¿ Branch: ${{ github.ref_name }}
          ğŸ“¦ Repo: ${{ github.repository }}
          
          ğŸ”— Quick Links:
          â€¢ View Changes: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
          â€¢ Action Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          â€¢ Source Code: https://github.com/${{ github.repository }}
          
          â° Built at: ${{ steps.vars.outputs.BUILD_TIME }}
          
          ğŸ³ Docker image tagged as: fs:${{ steps.vars.outputs.SHORT_SHA }}
          
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Furniture Shop API â€¢ Automated CI/CD

  notify-failure:
    runs-on: ubuntu-latest
    if: failure()
    needs: build
    steps:
    - name: Setup vars
      id: vars
      run: |
        echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "AUTHOR=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
        COMMIT_MSG=$(git log -1 --pretty=format:'%s')
        echo "COMMIT_MSG=$COMMIT_MSG" >> $GITHUB_OUTPUT
        echo "BUILD_TIME=$(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT
    
    - name: Send build failure message to Telegram
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          ğŸš¨ Furniture Shop CI/CD
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          ğŸ“Š Build Status: FAILED âŒ
          ğŸ·ï¸ Version: ${{ steps.vars.outputs.SHORT_SHA }}
          âš¡ Trigger: ${{ github.event_name }}
          ğŸ‘¤ Author: ${{ steps.vars.outputs.AUTHOR }}
          
          ğŸ“ Commit Message:
          ${{ steps.vars.outputs.COMMIT_MSG }}
          
          ğŸŒ¿ Branch: ${{ github.ref_name }}
          
          â— Issue: Docker build failed
          ğŸ”§ Action Required: Check build logs
          
          ğŸ”— Quick Links:
          â€¢ Failed Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          â€¢ View Changes: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
          
          â° Failed at: ${{ steps.vars.outputs.BUILD_TIME }}
          
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Furniture Shop API â€¢ Automated CI/CD